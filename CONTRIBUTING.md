# Contributing to fedex

This document provides guidance for developers and data managers working on the `fedex` package.

**For users:** See [README.md](README.md) for installation and usage instructions.

---

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Package Structure](#package-structure)
3. [Development Workflow](#development-workflow)
4. [Updating STAC When Data Changes](#updating-stac-when-data-changes)
5. [Testing](#testing)
6. [Key Design Decisions](#key-design-decisions)
7. [References](#references)

---

## Architecture Overview

The WRI data system has two separate components:

### Backend: `wri-data-processing` Repository

**Purpose:** Data preparation and STAC generation
**Users:** Data managers only
**Location:** `/home/shares/wwri-wildfire/MEDS-2026/wri-data-processing/`

**Responsibilities:**
- Extract metadata from raw GeoTIFFs
- Create Cloud Optimized GeoTIFFs (COGs)
- Upload COGs to KNB
- **Generate STAC catalog** with metadata

**Key Point:** This is where STAC is created, NOT in the fedex package.

### Frontend: `fedex` R Package

**Purpose:** Data access for end users
**Users:** Students, researchers, analysts
**Location:** `/home/shares/wwri-wildfire/MEDS-2026/fedex/`

**Responsibilities:**
- Ship with pre-generated STAC catalog (from backend)
- Provide functions to query STAC
- Retrieve COG data with spatial subsetting
- Handle CRS transformations and validation

**Key Point:** This package does NOT generate STAC. It uses pre-generated STAC from the backend.

### Workflow

```
wri-data-processing/          fedex/                    End Users
(Data Managers)               (R Package)               (Students/Researchers)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Extract metadata    â†’
2. Create COGs        â†’
3. Upload to KNB      â†’
4. Generate STAC      â†’      5. Copy STAC to          â†’
                             inst/extdata/stac/
                                    â†“
                             6. Release new
                             package version   â†’      7. Install package
                                                      8. Access data
                                                      9. Analyze!
```

**Design Rationale:** Separating data preparation from data access follows standard R package patterns and keeps the user-facing package simple.

---

## Package Structure

This package follows [R Packages (2e)](https://r-pkgs.org/) conventions:

```
fedex/
â”œâ”€â”€ DESCRIPTION              # Package metadata (Ch 9: Metadata)
â”œâ”€â”€ NAMESPACE                # Exported functions (Ch 11: NAMESPACE)
â”œâ”€â”€ LICENSE / LICENSE.md     # MIT License (Ch 9.6: License)
â”œâ”€â”€ README.md                # User documentation
â”œâ”€â”€ CONTRIBUTING.md          # This file - developer documentation
â”‚
â”œâ”€â”€ R/                       # Package functions (Ch 6: Code)
â”‚   â”œâ”€â”€ retrieve.R          # Main get_layer() function
â”‚   â”œâ”€â”€ spatial_validate.R  # Bbox and shapefile validation
â”‚   â”œâ”€â”€ extent_checks.R     # Overlap checking
â”‚   â”œâ”€â”€ complexity.R        # Geometry simplification
â”‚   â”œâ”€â”€ stac_config.R       # STAC catalog path
â”‚   â”œâ”€â”€ stac_utils.R        # STAC loading utilities
â”‚   â”œâ”€â”€ query_stac.R        # STAC filtering
â”‚   â”œâ”€â”€ list_domains.R      # Domain listing
â”‚   â””â”€â”€ data.R              # Package data documentation (Ch 7: Data)
â”‚
â”œâ”€â”€ data/                    # Package data objects (Ch 7: Data)
â”‚   â””â”€â”€ wri_extent.rda      # Pre-computed extent information
â”‚
â”œâ”€â”€ data-raw/                # Scripts to generate data/ (Ch 7.3: Raw data)
â”‚   â””â”€â”€ wri_extent.R        # Generates wri_extent.rda
â”‚
â”œâ”€â”€ inst/                    # Installed files (Ch 7.4: Internal data)
â”‚   â””â”€â”€ extdata/            # External data shipped with package
â”‚       â”œâ”€â”€ stac/           # Pre-generated STAC catalog (from backend)
â”‚       â””â”€â”€ metadata.csv    # Pre-generated metadata (from backend)
â”‚
â”œâ”€â”€ man/                     # Generated documentation (Ch 10: Documentation)
â”‚   â””â”€â”€ *.Rd                # Auto-generated by roxygen2
â”‚
â”œâ”€â”€ demos/                   # Demonstration scripts (not in standard structure)
â”‚   â”œâ”€â”€ README.md           # Demo documentation
â”‚   â”œâ”€â”€ test_cog_streaming_verified.R  # Main COG verification demo
â”‚   â”œâ”€â”€ original_test_cog_steaming.R   # Archived detailed version
â”‚   â””â”€â”€ *.png               # Example outputs
â”‚
â””â”€â”€ tests/                   # Unit tests (Ch 13: Testing)
    â”œâ”€â”€ testthat.R          # Test runner
    â””â”€â”€ testthat/           # Test files
```

**Reference:** [R Packages (2e)](https://r-pkgs.org/) - Comprehensive guide to R package development

---

## Development Workflow

### Setup (One Time)

```r
# Install development tools
install.packages(c("devtools", "roxygen2", "testthat", "usethis"))

# Clone repository
cd /home/shares/wwri-wildfire/MEDS-2026/
git clone <repo-url> fedex
cd fedex

# Install package dependencies
devtools::install_deps()
```

### Regular Development Cycle

```r
# 1. Edit code in R/ directory

# 2. Document changes (updates man/ and NAMESPACE)
devtools::document()

# 3. Load package for interactive testing
devtools::load_all()

# 4. Test your changes
my_test <- get_layer("WRI_score", bbox = c(-122, 37, -121, 38))
plot(my_test)

# 5. Run automated tests
devtools::test()

# 6. Check package (runs R CMD check)
devtools::check()

# 7. Commit changes
git add -A
git commit -m "Descriptive message"
git push
```

### Adding New Functions

```r
# Create new R file
usethis::use_r("my_function")

# Write function with roxygen2 documentation
#' Short title
#'
#' Longer description
#'
#' @param x Description
#' @return Description
#' @export
my_function <- function(x) {
  # Implementation
}

# Document
devtools::document()

# Create tests
usethis::use_test("my_function")

# Edit tests/testthat/test-my_function.R
test_that("my_function works", {
  result <- my_function(1)
  expect_equal(result, expected_value)
})
```

### Adding Dependencies

```r
# Add to Imports (required packages)
usethis::use_package("new_package")

# Add to Suggests (optional packages for vignettes/tests)
usethis::use_package("optional_package", type = "Suggests")
```

**Reference:** [Ch 3: System setup](https://r-pkgs.org/setup.html), [Ch 6: R code](https://r-pkgs.org/code.html)

---

## Updating STAC When Data Changes

**Important:** STAC generation happens in `wri-data-processing`, NOT in `fedex`.

### For Data Managers

When new COGs are uploaded to KNB or metadata changes:

#### Step 1: Generate STAC in Backend Repository

```bash
cd /home/shares/wwri-wildfire/MEDS-2026/wri-data-processing/

# Extract metadata from COGs
Rscript scripts/00b_extract_metadata_all.R

# Generate STAC catalog with KNB URLs
# First, edit scripts/02b_make_stac_all.R:
#   Set use_knb_urls <- TRUE
Rscript scripts/02b_make_stac_all.R

# Verify output
ls scratch_output/stac_hosted/
# Should contain: catalog.json, collections/wri_ignitR/
```

#### Step 2: Copy STAC to fedex Package

```bash
cd /home/shares/wwri-wildfire/MEDS-2026/fedex/

# Backup current STAC (optional)
cp -r inst/extdata/stac inst/extdata/stac_backup_$(date +%Y%m%d)

# Copy new STAC from backend
cp -r ../wri-data-processing/scratch_output/stac_hosted/* inst/extdata/stac/

# Copy updated metadata CSV
cp ../wri-data-processing/config/all_layers_consistent.csv inst/extdata/metadata.csv

# Verify
ls inst/extdata/stac/collections/wri_ignitR/items/
# Should show all layer JSON files
```

#### Step 3: Update Package Version

```r
# Bump version number (patch = 0.1.0 â†’ 0.1.1, minor = 0.1.0 â†’ 0.2.0)
usethis::use_version("patch")  # or "minor" for new layers

# Document
devtools::document()

# Check package
devtools::check()
```

#### Step 4: Test Updated Package

```r
# Install locally
devtools::install()

# Test in fresh R session
library(fedex)

# Verify new layers appear
items <- load_stac_items()
length(items)  # Should reflect new layer count

# Test retrieval
wri <- get_layer('WRI_score', bbox = c(-122, 37, -121, 38))
plot(wri)
```

#### Step 5: Release New Version

```bash
# Commit changes
git add -A
git commit -m "Update STAC catalog with new layers (v0.X.Y)"
git push

# Tag release (optional)
git tag -a v0.X.Y -m "Version 0.X.Y - Updated STAC catalog"
git push origin v0.X.Y
```

### For Package Users

Users simply update to the latest version:

```r
# If package is on GitHub
devtools::install_github("your-org/fedex")

# If package is on CRAN (future)
install.packages("fedex")
```

The updated STAC catalog is automatically included with the new package version.

**Reference:** [Ch 7.4: Internal data](https://r-pkgs.org/data.html#sec-data-extdata), [Ch 20: Releasing a package](https://r-pkgs.org/lifecycle.html)

---

## Testing

### Running Tests

```r
# Run all tests
devtools::test()

# Run specific test file
devtools::test_file("tests/testthat/test-retrieve.R")

# Run tests with coverage
covr::package_coverage()
```

### Writing Tests

Tests live in `tests/testthat/test-*.R`:

```r
test_that("validate_bbox works with WGS84", {
  bbox <- c(-122, 37, -121, 38)
  result <- validate_bbox(bbox)

  expect_type(result, "list")
  expect_true("bbox_5070" %in% names(result))
  expect_s4_class(result$bbox_5070, "SpatExtent")
})

test_that("validate_bbox errors on invalid input", {
  # xmin > xmax
  bbox_invalid <- c(-121, 37, -122, 38)

  expect_error(
    validate_bbox(bbox_invalid),
    "xmin must be < xmax"
  )
})
```

### Test Guidelines

- **Use `skip_on_cran()`** for tests that require internet
- **Use `skip_if_offline()`** for tests that download data
- **Keep tests fast** - use small bboxes for retrieval tests
- **Test edge cases** - invalid inputs, no overlap, complex geometries
- **Test error messages** - ensure informative errors

**Reference:** [Ch 13: Testing](https://r-pkgs.org/testing-basics.html)

---

## Key Design Decisions

### 1. Why Ship Pre-Generated STAC Instead of Generating It?

**Decision:** STAC catalog is generated in `wri-data-processing` and copied to `fedex/inst/extdata/stac/`

**Rationale:**
- **Separation of concerns:** Backend (data prep) vs Frontend (data access)
- **Standard R package pattern:** Packages ship with data, they don't create it
- **Simpler for users:** Never need to regenerate STAC or have raw data files
- **Version control:** STAC is versioned with package releases
- **Offline use:** Can query STAC without internet (only retrieval needs internet)

**Reference:** [Ch 7: Data](https://r-pkgs.org/data.html)

### 2. Why Store `wri_extent` as Package Data?

**Decision:** Store extent information as an `.rda` file in `data/`

**Rationale:**
- **Performance:** Validate extent without loading full STAC
- **Offline use:** Can check overlap before attempting download
- **Single source of truth:** All layers share same extent
- **Fast loading:** Lazy-loaded with package

**Reference:** [Ch 7.1: Exported data](https://r-pkgs.org/data.html#sec-data-data)

### 3. Why Auto-Simplify Complex Geometries?

**Decision:** `get_layer()` has `simplify = TRUE` by default

**Rationale:**
- **User experience:** Prevents 30+ minute hangs on detailed shapefiles
- **Safe default:** Students may not know to simplify
- **Transparent:** Users are warned when simplification occurs
- **Override available:** Advanced users can set `simplify = FALSE`

**Benchmark:** Shapefile with >10,000 vertices takes >30 seconds to process

### 4. Why Auto-Detect CRS from Bbox Values?

**Decision:** `validate_bbox()` auto-detects EPSG:4326 or EPSG:5070 when `crs = NULL`

**Rationale:**
- **Convenience:** Most common case is WGS84 lat/lon coordinates
- **Clear messaging:** Tells user what was detected
- **Override available:** User can specify `crs =` explicitly
- **Fail safely:** Errors if CRS can't be determined

**Reference:** [Ch 18: Errors](https://r-pkgs.org/errors.html)

### 5. Why Use `/vsicurl/` for COG Access?

**Decision:** Use GDAL's virtual file system for remote access

**Rationale:**
- **Efficient:** Only downloads requested tiles, not entire file
- **Standard approach:** How COGs are meant to be accessed
- **Transparent:** Works like local file to terra/sf
- **Minimal dependencies:** Built into GDAL (already required)

**Performance:** Small bbox (~50km) downloads ~10 MB instead of 3.5 GB

**Reference:** [GDAL Virtual File Systems](https://gdal.org/user/virtual_file_systems.html)

---

## References

### R Package Development

- **[R Packages (2e)](https://r-pkgs.org/)** - Comprehensive guide by Hadley Wickham & Jennifer Bryan
  - [Ch 1: Introduction](https://r-pkgs.org/introduction.html)
  - [Ch 3: System setup](https://r-pkgs.org/setup.html)
  - [Ch 6: R code](https://r-pkgs.org/code.html)
  - [Ch 7: Data](https://r-pkgs.org/data.html)
  - [Ch 9: Metadata](https://r-pkgs.org/description.html)
  - [Ch 10: Documentation](https://r-pkgs.org/man.html)
  - [Ch 11: NAMESPACE](https://r-pkgs.org/dependencies-mindset-background.html)
  - [Ch 13: Testing](https://r-pkgs.org/testing-basics.html)
  - [Ch 18: Errors](https://r-pkgs.org/errors.html)
  - [Ch 20: Releasing](https://r-pkgs.org/lifecycle.html)

### Geospatial Data

- **[Cloud Optimized GeoTIFF](https://www.cogeo.org/)** - COG specification
- **[STAC Specification](https://stacspec.org/)** - SpatioTemporal Asset Catalog
- **[GDAL Virtual File Systems](https://gdal.org/user/virtual_file_systems.html)** - `/vsicurl/` documentation
- **[terra R package](https://rspatial.github.io/terra/)** - Raster operations

### Related Documentation

- **[wri-data-processing/README.md](../wri-data-processing/README.md)** - Backend pipeline documentation
- **[fedex/README.md](README.md)** - User-facing package documentation
- **[fedex/demos/README.md](demos/README.md)** - COG streaming demos

---

## Getting Help

- **Package issues:** Open an issue on GitHub
- **Development questions:** See [R Packages (2e)](https://r-pkgs.org/)
- **STAC/COG questions:** See [demos/README.md](demos/README.md)

---

## Contribution Guidelines

1. **Follow the style:** Use [tidyverse style guide](https://style.tidyverse.org/)
2. **Document all functions:** Use roxygen2 comments
3. **Write tests:** Aim for >70% code coverage
4. **Check your work:** `devtools::check()` must pass with 0 errors/warnings
5. **Update NEWS.md:** Document user-facing changes
6. **One feature per commit:** Keep commits focused and descriptive

**Thank you for contributing to fedex!** ðŸŽ‰
